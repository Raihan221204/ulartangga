<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ular Tangga - Outing Schoters</title>
  <style>
    :root{--board-gap:12px}
    html,body{height:100%;margin:0;overflow:hidden}
    body{
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-size:400% 400%;
      animation:gradientShift 15s ease infinite;
      color:#fff;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      position:relative;
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .stage{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:12px;box-sizing:border-box;position:relative;z-index:1}
    .board-wrap{position:relative;max-width:calc(100vmin - var(--board-gap));max-height:calc(100vmin - var(--board-gap));width:100%;height:100%;display:block}
    #board{width:100%;height:100%;background-image:url('board.jpeg');background-size:contain;background-repeat:no-repeat;background-position:center center;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.4), 0 0 0 4px rgba(255,255,255,0.1);position:relative;overflow:visible;backdrop-filter:blur(10px)}
    .grid{position:absolute;left:0;top:0;right:0;bottom:0;display:grid;grid-template-columns:repeat(10,1fr);grid-template-rows:repeat(10,1fr);pointer-events:none}
    .cell{border:0;box-sizing:border-box}
    #players-container{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
    .player{position:absolute;width:calc(6%);height:calc(6%);min-width:18px;min-height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.9);box-shadow:0 6px 20px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:#fff;transform:translate(-50%,-50%);transition:left 350ms ease, top 350ms ease, transform 300ms ease;text-shadow:0 2px 4px rgba(0,0,0,0.8)}
    .player.active { transform: translate(-50%, -50%) scale(1.2); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.3); } 50% { box-shadow: 0 8px 30px rgba(0,0,0,0.6), 0 0 35px rgba(255, 255, 100, 0.7); } 100% { box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.3); } }

    #player-positions-panel { position: fixed; top: 12px; left: 0; width: 100%; z-index: 10010; padding: 0 12px; box-sizing: border-box; overflow-x: auto; scrollbar-width: none; }
    #player-positions-panel::-webkit-scrollbar { display: none; }
    #positionsList { display: flex; flex-direction: row; gap: 10px; list-style: none; padding: 0; margin: 0; width: max-content; }
    .pos-item { background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95)); padding: 8px 14px; border-radius: 12px; font-size: 13px; color: #fff; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1); white-space: nowrap; backdrop-filter: blur(10px); transition: transform 200ms ease, box-shadow 200ms ease; }
    .pos-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.2); }
    .pos-color-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .pos-item strong { font-size: 15px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }

    @media (min-width: 900px) {
      #player-positions-panel { top: 50%; transform: translateY(-50%); left: 18px; width: auto; max-height: 80vh; padding: 0; overflow-x: hidden; overflow-y: auto; }
      #positionsList { flex-direction: column; width: auto; }
    }

    .gear{ position:fixed; right:16px; bottom:16px; z-index:10050; width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg, #06b6d4, #0891b2); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 40px rgba(0,0,0,0.4), 0 0 20px rgba(6, 182, 212, 0.3); cursor:pointer; font-size:24px; transition: transform 300ms ease, box-shadow 300ms ease; }
    .gear:hover{ transform: rotate(90deg) scale(1.1); box-shadow:0 12px 50px rgba(0,0,0,0.5), 0 0 30px rgba(6, 182, 212, 0.5); }
    .gear.hidden{ display:none; }
    .logout-btn{ position:fixed; right:16px; bottom:90px; z-index:10050; width:auto; padding:10px 16px; border-radius:12px; background:linear-gradient(135deg, #ef4444, #dc2626); color:#fff; display:none; font-weight:700; box-shadow:0 8px 30px rgba(0,0,0,0.4); cursor:pointer; transition: transform 200ms ease, box-shadow 200ms ease; }
    .logout-btn:hover{ transform: translateY(-2px); box-shadow:0 10px 35px rgba(0,0,0,0.5); }
    
    .settings-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:10000; }
    .settings-card{ width:380px; background:#ffffff; color:#071022; border-radius:20px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1); box-sizing:border-box; max-height:90vh; overflow:auto; }
    .settings-card h3{ margin:0 0 12px 0; font-size:22px; color:#071022; font-weight:800 }
    .settings-card label{ display:block; font-size:14px; margin-top:12px; color:#334155; font-weight:600 }
    .settings-card input, .settings-card select { width:100%; padding:10px 12px; border-radius:10px; border:2px solid #e5e7eb; box-sizing:border-box; margin-top:6px; font-size:14px; transition: border-color 200ms ease; }
    .settings-card input:focus, .settings-card select:focus { outline:none; border-color:#667eea; }
    .settings-card .row{ display:flex; gap:10px; margin-top:12px }
    .btn{ padding:10px 14px; border-radius:10px; border:0; cursor:pointer; background:linear-gradient(135deg, #667eea, #764ba2); color:#fff; font-weight:700; font-size:14px; transition: transform 200ms ease, box-shadow 200ms ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
    .btn:active{ transform: translateY(0); }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }
    .btn.ghost{ background:transparent; border:2px solid #cbd5e1; color:#071022; box-shadow:none; }
    .btn.ghost:hover{ background:#f1f5f9; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    .btn.danger{ background:linear-gradient(135deg, #ef4444, #dc2626); color:#fff; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
    .btn.danger:hover{ box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5); }
    .small{ font-size:13px; color:#64748b; margin-top:8px; line-height:1.5 }

    .dice-wrap{ display:flex; gap:14px; align-items:center; margin-top:12px }
    .dice { width:70px; height:70px; border-radius:12px; display:flex;align-items:center;justify-content:center; font-weight:900; font-size:28px; background:linear-gradient(135deg, #1e293b, #0f172a); color:#fff; box-shadow:0 8px 25px rgba(0,0,0,0.4), inset 0 2px 4px rgba(255,255,255,0.1); transform-origin:center; transition:transform 600ms cubic-bezier(.2,.9,.25,1); }
    .dice.rolling { animation: diceRoll 800ms cubic-bezier(.2,.7,.2,1); }
    @keyframes diceRoll { 0% { transform: rotate(0) scale(1); } 25% { transform: rotate(90deg) scale(1.1); } 50% { transform: rotate(180deg) scale(1.05); } 75% { transform: rotate(270deg) scale(1.1); } 100% { transform: rotate(360deg) scale(1); } }

    .viewer-info { position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:10020; background:linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95)); padding:12px 18px; border-radius:16px; font-size:14px; display:flex; gap:14px; align-items:center; box-shadow:0 10px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1); pointer-events:none; backdrop-filter:blur(10px); }
    .viewer-info .item { display:flex; gap:8px; align-items:center; color:#fff; font-weight:500 }
    .viewer-dice { width:32px; height:32px; border-radius:8px; background:linear-gradient(135deg, #1e293b, #0f172a); display:flex;align-items:center;justify-content:center; font-weight:800; font-size:16px; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.1); }

    @media (min-width:900px){ .viewer-info { left:auto; transform:none; right:90px; bottom:18px; } }
    @media (max-width:720px){
      .settings-card{ width:94%; border-radius:16px; padding:16px }
      .gear{ right:12px; bottom:12px; width:54px; height:54px; font-size:20px }
      .logout-btn{ right:12px; bottom:78px; padding:8px 12px; font-size:13px }
      .player{ font-size:10px }
      .viewer-info{ bottom:12px; padding:10px 14px; font-size:13px; gap:10px }
      .viewer-dice{ width:28px; height:28px; font-size:14px }
      .pos-item{ padding:6px 10px; font-size:12px }
    }
  </style>
</head>
<body>
  <div class="stage" aria-hidden="false">
    <div class="board-wrap">
      <div id="board" aria-label="Papan Ular Tangga">
        <div class="grid" id="grid"></div>
        <div id="players-container"></div>
      </div>
    </div>
  </div>
  
  <div id="player-positions-panel">
    <ul id="positionsList"></ul>
  </div>

  <div id="gearBtn" class="gear hidden" title="Pengaturan (admin)">‚öôÔ∏è</div>
  <div id="logoutBtn" class="logout-btn" title="Logout (admin)">Logout</div>

  <div id="settingsBackdrop" class="settings-backdrop" role="dialog" aria-modal="true">
    <div class="settings-card" role="document">
      <h3>‚öôÔ∏è Pengaturan Admin</h3>
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small" id="adminEmail">-</div>
        <button id="closeSettings" class="btn ghost">Tutup</button>
      </div>
      <hr style="margin:20px 0; border:none; border-top:2px solid #e5e7eb" />
      <label style="font-size: 17px; font-weight: 800; margin-bottom: 4px;">üé≤ Lakukan Lemparan Langsung</label>
      <div class="small" style="margin-top:0; margin-bottom:10px;">Pilih tim, lalu kocok dadu.</div>
      <label>Pilih Tim</label>
      <select id="directRollPlayerSelect"></select>
      <div class="row">
        <button id="directRollBtn" class="btn" style="flex:1;">Kocok Dadu & Gerakkan Tim</button>
      </div>
      <div style="height:10px"></div>
      <div class="dice-wrap">
        <div class="dice" id="diceBox">-</div>
        <div style="flex:1">
          <div class="small" id="diceEvent" style="font-weight:600; color:#334155">Hasil dadu: -</div>
        </div>
      </div>
      <hr style="margin:20px 0; border:none; border-top:2px solid #e5e7eb" />
      <label style="font-size: 17px; font-weight: 800;">üìç Pindahkan Tim (Manual)</label>
      <select id="cfgMovePlayer"></select>
      <label>Ke petak (1-100)</label>
      <input id="cfgMoveTarget" type="number" min="1" max="100" value="1" />
      <div class="row">
        <button id="cfgMoveBtn" class="btn">Move</button>
        <button id="cfgMoveReset" class="btn ghost">Reset Posisi</button>
      </div>
      <hr style="margin:20px 0; border:none; border-top:2px solid #e5e7eb" />
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small" style="font-weight:600">üîÑ Reset seluruh game</div>
        <button id="cfgReset" class="btn danger">Reset</button>
      </div>
    </div>
  </div>

  <div id="viewerInfo" class="viewer-info" aria-hidden="false">
    <div class="item"><div class="viewer-dice" id="viewerDice">-</div></div>
    <div class="item" id="viewerTurn">üé≤ Selamat Bermain!</div>
    <div class="item" id="viewerLast">üßÆ Dadu: -</div>
  </div>

  <div id="roleModalBackdrop" class="settings-backdrop" style="z-index:10060; display:flex">
    <div class="settings-card" style="width:340px">
      <h3>üéÆ Pilih Peran</h3>
      <div style="display:flex;gap:12px;margin-top:12px">
        <button id="roleViewer" class="btn ghost" style="flex:1">üëÅÔ∏è Viewer</button>
        <button id="roleAdmin" class="btn" style="flex:1">üîë Admin</button>
      </div>
      <div id="adminForm" style="display:none;margin-top:16px">
        <label>Email</label><input id="loginEmail" type="email" placeholder="admin@email.com" /><label>Password</label><input id="loginPass" type="password" /><div style="display:flex;gap:10px;margin-top:12px"><button id="loginBtn" class="btn" style="flex:1">Login</button><button id="loginCancel" class="btn ghost">Batal</button></div>
      </div>
    </div>
  </div>

  <div id="notificationBackdrop" class="settings-backdrop" style="z-index: 10070;">
    <div class="settings-card" style="width: 320px; text-align: center;">
      <h3 id="notificationTitle" style="margin-bottom: 10px;">üì¢ Pemberitahuan</h3>
      <p id="notificationMessage" style="font-size: 14px; color: #334155; margin-top: 0; line-height:1.6">-</p>
      <button id="notificationCloseBtn" class="btn" style="margin-top: 16px;">OK</button>
    </div>
  </div>
  
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyCkMCtgyRGnP79OMt7E5O_Vd1CqHXhugbY",
      authDomain: "ulartangga-e8151.firebaseapp.com",
      databaseURL: "https://ulartangga-e8151-default-rtdb.firebaseio.com",
      projectId: "ulartangga-e8151",
      storageBucket: "ulartangga-e8151.firebasestorage.app",
      messagingSenderId: "414813226733",
      appId: "1:414813226733:web:2b3b770fe315b13acb2ee4",
      measurementId: "G-EN7VY6P94Z"
    };
    const ADMIN_EMAILS = ['adminouting@gmail.com', 'adminouting1@gmail.com', 'adminouting2@gmail.com', 'raihan.fadil@schoters.com'];

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, onValue, update, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

   const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- UBAH BAGIAN INI ---
    const totalPlayers = 19; // Ganti 16 menjadi 19
    const ladders = {2:38,7:14,15:26,28:84,21:42,36:44,51:67,71:91,78:98,87:94,8:31};
    const snakes  = {16:6,49:11,46:25,62:19,64:60,74:53,89:68,92:88,95:75,99:80};
    
    // Tambahkan 3 warna baru di paling belakang array ini
    const playerColors = [
        '#FF5733','#33FF57','#3357FF','#FF33A1','#A133FF','#33FFA1',
        '#FFC300','#C70039','#900C3F','#581845','#00FFFF','#FF00FF',
        '#0000FF','#00FF00','#FFFF00','#000000',
        '#808080', '#8B4513', '#008080' // <-- Warna untuk Tim 17, 18, 19
    ];
    // -----------------------

    const gearBtn = document.getElementById('gearBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettings = document.getElementById('closeSettings');
    const adminEmailEl = document.getElementById('adminEmail');
    const diceBox = document.getElementById('diceBox');
    const diceEvent = document.getElementById('diceEvent');
    const cfgMovePlayer = document.getElementById('cfgMovePlayer');
    const cfgMoveTarget = document.getElementById('cfgMoveTarget');
    const cfgMoveBtn = document.getElementById('cfgMoveBtn');
    const cfgMoveReset = document.getElementById('cfgMoveReset');
    const cfgReset = document.getElementById('cfgReset');
    const roleModalBackdrop = document.getElementById('roleModalBackdrop');
    const roleViewer = document.getElementById('roleViewer');
    const roleAdmin = document.getElementById('roleAdmin');
    const adminForm = document.getElementById('adminForm');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const loginBtn = document.getElementById('loginBtn');
    const loginCancel = document.getElementById('loginCancel');
    const viewerInfo = document.getElementById('viewerInfo');
    const viewerDice = document.getElementById('viewerDice');
    const viewerTurn = document.getElementById('viewerTurn');
    const viewerLast = document.getElementById('viewerLast');
    const grid = document.getElementById('grid');
    const board = document.getElementById('board');
    const playersContainer = document.getElementById('players-container');
    const positionsList = document.getElementById('positionsList');
    const directRollPlayerSelect = document.getElementById('directRollPlayerSelect');
    const directRollBtn = document.getElementById('directRollBtn');
    const notificationBackdrop = document.getElementById('notificationBackdrop');
    const notificationTitle = document.getElementById('notificationTitle');
    const notificationMessage = document.getElementById('notificationMessage');
    const notificationCloseBtn = document.getElementById('notificationCloseBtn');

    function showNotification(message, title = "Pemberitahuan") {
      notificationTitle.innerText = title;
      notificationMessage.innerText = message;
      notificationBackdrop.style.display = 'flex';
    }
    notificationCloseBtn.addEventListener('click', () => { notificationBackdrop.style.display = 'none'; });
    
    function createGridCells(){ grid.innerHTML=''; for(let i=0;i<100;i++){ const cell=document.createElement('div'); cell.className='cell'; cell.dataset.index=i+1; grid.appendChild(cell);} }
    function createPlayers(){ playersContainer.innerHTML=''; for(let i=0;i<totalPlayers;i++){ const p=document.createElement('div'); p.className='player'; p.id=`player-${i+1}`; p.style.backgroundColor=playerColors[i]; p.innerText=i+1; playersContainer.appendChild(p);} }
    function populateSelects(){ cfgMovePlayer.innerHTML=''; directRollPlayerSelect.innerHTML = ''; for(let i=1;i<=totalPlayers;i++){ const m=document.createElement('option'); m.value=i; m.innerText=`Tim ${i}`; cfgMovePlayer.appendChild(m); const d=document.createElement('option'); d.value=i; d.innerText=`Tim ${i}`; directRollPlayerSelect.appendChild(d); } }
    function computeCellCenters(){ const cells=Array.from(grid.children);const centers={};for(let num=1;num<=100;num++){const row=Math.floor((num-1)/10);const fromBottom=row;const topRowIndex=9-fromBottom;const inRowIndex=(num-1)%10;const leftToRight=((fromBottom)%2===0);const col=leftToRight?inRowIndex:(9-inRowIndex);const domIndex=topRowIndex*10+col;const cell=cells[domIndex];if(cell){const rect=cell.getBoundingClientRect();const boardRect=board.getBoundingClientRect();const cx=(rect.left+rect.right)/2-boardRect.left;const cy=(rect.top+rect.bottom)/2-boardRect.top;centers[num]={x:cx/boardRect.width,y:cy/boardRect.height}}}return centers }
    function updatePlayerElementLocal(playerId,centers,pos){const el=document.getElementById(`player-${playerId}`);const c=centers[pos];if(!c)return;el.style.left=(c.x*100)+'%';el.style.top=(c.y*100)+'%'}
    function updatePositionsPanel(playerPositions){if(!positionsList)return;let content='';for(let i=1;i<=totalPlayers;i++){const pos=playerPositions[i]||1;const color=playerColors[i-1];content+=`<li class="pos-item"><span class="pos-color-dot" style="background-color:${color};"></span> Tim ${i}: <strong>${pos}</strong></li>`}positionsList.innerHTML=content}
    
    async function animatePathAndWrite(teamId, pathArray){
      const playerEl = document.getElementById(`player-${teamId}`);
      playerEl.classList.add('active');
      const delay = 350;
      for(let i=0; i < pathArray.length; i++){
        const pos = pathArray[i];
        await update(ref(db, `game/playerPositions`), { [teamId]: pos });
        await new Promise(res => setTimeout(res, delay));
      }
      playerEl.classList.remove('active');
    }

    async function performRollAndMove(teamId) {
        const gameSnap = await get(ref(db, 'game'));
        const positions = gameSnap.val().playerPositions || Object.fromEntries(Array.from({ length: totalPlayers }, (_, i) => [i + 1, 1]));
        const r = Math.floor(Math.random() * 6) + 1;
        const cur = Number(positions[teamId]) || 1;
        
        const potentialLanding = cur + r;
        let landing;
        const path = [];

        if (potentialLanding > 100) {
            landing = 100 - (potentialLanding - 100);
            for (let s = cur + 1; s <= 100; s++) path.push(s);
            for (let s = 99; s >= landing; s--) path.push(s);
        } else {
            landing = potentialLanding;
            for (let s = cur + 1; s <= landing; s++) path.push(s);
        }

        const after = ladders[landing] || snakes[landing] || null;
        const finalPos = after || landing;

        let eventText = `Tim ${teamId} dapat dadu ${r}`;
        if (potentialLanding > 100) {
            eventText += ` ‚Üí 100 ‚Üí mundur ke ${landing}`;
        } else {
            eventText += ` ‚Üí ${landing}`;
        }
        if (after) {
            eventText += ` ‚Üí ${finalPos}`;
        }

        animateDiceTo(r);
        await update(ref(db, 'game'), { lastDice: r, lastEvent: `Menggerakkan Tim ${teamId}...` });
        
        if (path.length > 0) await animatePathAndWrite(teamId, path);
        if (after) {
            await animatePathAndWrite(teamId, [after]);
        }
        
        const finalPositions = (await get(ref(db, 'game/playerPositions'))).val() || positions;
        finalPositions[teamId] = finalPos;
        
        await update(ref(db, 'game'), { playerPositions: finalPositions, lastEvent: eventText, updatedAt: Date.now() });

        if (finalPos === 100) {
            showNotification(`Selamat! Tim ${teamId} telah mencapai garis finish!`, "üèÜ PEMENANG üèÜ");
        }
    }

    directRollBtn.addEventListener('click', async () => {
        const teamId = Number(directRollPlayerSelect.value);
        const gameRef = ref(db, 'game');

        const currentState = await get(gameRef);
        const currentPos = currentState.exists() ? (currentState.val().playerPositions[teamId] || 1) : 1;

        if (currentPos === 100) {
            showNotification(`Tim ${teamId} sudah menang dan tidak bisa digerakkan lagi.`);
            return;
        }

        directRollBtn.disabled = true;
        directRollBtn.innerText = 'Memeriksa...';

        runTransaction(gameRef, (gameData) => {
            if (gameData) {
                if (gameData.isBusy) return; 
                gameData.isBusy = true;
            }
            return gameData;
        }).then(async (result) => {
            if (!result.committed) {
                showNotification("Admin lain sedang mengocok dadu, mohon bersabar.");
                directRollBtn.disabled = false;
                directRollBtn.innerText = 'Kocok Dadu & Gerakkan Tim';
            } else {
                directRollBtn.innerText = 'Mengocok...';
                try {
                    await performRollAndMove(teamId);
                } catch (err) { 
                    alert('Terjadi kesalahan: ' + err.message);
                } finally {
                    await update(gameRef, { isBusy: false });
                    directRollBtn.disabled = false;
                    directRollBtn.innerText = 'Kocok Dadu & Gerakkan Tim';
                }
            }
        }).catch((error) => {
            console.error("Transaction failed: ", error);
            update(gameRef, { isBusy: false });
            directRollBtn.disabled = false;
            directRollBtn.innerText = 'Kocok Dadu & Gerakkan Tim';
        });
    });

    async function adminMovePlayer(teamId, targetSquare){
      if(teamId < 1 || teamId > totalPlayers || targetSquare < 1 || targetSquare > 100) return;
      const snap = await get(ref(db,'game'));
      const state = snap.exists() ? snap.val() : {};
      const positions = state.playerPositions || Object.fromEntries(Array.from({length:totalPlayers},(_,i)=>[i+1,1]));
      positions[teamId] = targetSquare;
      await update(ref(db,'game'), { playerPositions: positions, lastEvent: `Admin memindah Tim ${teamId} ‚Üí ${targetSquare}`, updatedAt: Date.now() });
    }
    async function adminResetGame(){
      if(!confirm('Yakin reset seluruh game? Semua data akan kembali ke awal.')) return;
      const defaultPositions = Object.fromEntries(Array.from({length:totalPlayers},(_,i)=>[i+1,1]));
      await set(ref(db,'game'), { playerPositions: defaultPositions, lastDice: null, lastEvent: 'Game di-reset oleh admin', updatedAt: Date.now(), isBusy: false });
    }
    
    let lastSeenDice = null;
    function attachListeners(){
      onValue(ref(db,'game'),(snap)=>{
        const state = snap.exists() ? snap.val() : {};
        const p = state.playerPositions || {};
        const centers = computeCellCenters();
        for(let i=1;i<=totalPlayers;i++){ updatePlayerElementLocal(i,centers,Number(p[i]||1)); }
        updatePositionsPanel(p);
        if(state.lastDice !== undefined && state.lastDice !== null){
          diceBox.innerText = state.lastDice;
          if(lastSeenDice !== state.lastDice){
            viewerDice.innerText = '...';
            viewerDice.style.transform = 'scale(1.05) rotate(15deg)';
            setTimeout(()=>{ viewerDice.style.transform=''; viewerDice.innerText=state.lastDice; }, 700);
            lastSeenDice = state.lastDice;
          }
          viewerLast.innerText = `üßÆ Dadu: ${state.lastDice}`;
        } else {
          viewerLast.innerText = 'üßÆ Dadu: -';
        }
        diceEvent.innerText = state.lastEvent || 'Hasil dadu: -';
      });
    }

    gearBtn.addEventListener('click',()=>settingsBackdrop.style.display='flex');
    closeSettings.addEventListener('click',()=>settingsBackdrop.style.display='none');
    function populateAll(){
      populateSelects();
      const centers=computeCellCenters();
      get(ref(db,'game')).then(snap=>{
        const state=snap.exists()?snap.val():{};
        const p=state.playerPositions||{};
        for(let i=1;i<=totalPlayers;i++){ updatePlayerElementLocal(i,centers,Number(p[i]||1)); }
        updatePositionsPanel(p);
        if(state.lastDice!==undefined&&state.lastDice!==null){
          diceBox.innerText=state.lastDice;
          viewerDice.innerText=state.lastDice;
        }
        diceEvent.innerText=state.lastEvent||'Hasil dadu: -';
        viewerLast.innerText=state.lastDice!==undefined&&state.lastDice!==null?`üßÆ Dadu: ${state.lastDice}`:'üßÆ Dadu: -';
      });
    }
    function animateDiceTo(number){
      diceBox.classList.remove('rolling');
      void diceBox.offsetWidth;
      diceBox.classList.add('rolling');
      diceBox.innerText='...';
      setTimeout(()=>{diceBox.classList.remove('rolling');diceBox.innerText=number}, 800);
    }
    cfgMoveBtn.addEventListener('click',async()=>{const t=Number(cfgMovePlayer.value);const target=Number(cfgMoveTarget.value);if(!confirm(`Pindahkan Tim ${t} ke petak ${target}?`))return;try{await adminMovePlayer(t,target);alert('Berhasil memindahkan.')}catch(err){alert('Gagal memindahkan: '+err.message)}});
    cfgMoveReset.addEventListener('click',async()=>{const t=Number(cfgMovePlayer.value);if(!confirm(`Kembalikan Tim ${t} ke kotak 1?`))return;try{await adminMovePlayer(t,1);alert('Berhasil kembalikan.')}catch(err){alert('Gagal: '+err.message)}});
    cfgReset.addEventListener('click',async()=>{await adminResetGame();alert('Game berhasil di-reset.');settingsBackdrop.style.display='none'});
    logoutBtn.addEventListener('click',async()=>{try{await signOut(auth)}catch(err){alert('Gagal logout: '+err.message)}});
    roleViewer.addEventListener('click',()=>{roleModalBackdrop.style.display='none';document.querySelector('.stage').setAttribute('aria-hidden','false');attachListeners();populateAll()});
    roleAdmin.addEventListener('click',()=>adminForm.style.display='block');
    loginCancel.addEventListener('click',()=>adminForm.style.display='none');
    loginBtn.addEventListener('click',async()=>{const e=loginEmail.value.trim();const p=loginPass.value;if(!e||!p)return;try{await signInWithEmailAndPassword(auth,e,p)}catch(err){alert('Login gagal: '+err.message)}});
    
    onAuthStateChanged(auth,user=>{
      if(user && ADMIN_EMAILS.includes(user.email)){
        roleModalBackdrop.style.display='none';
        document.querySelector('.stage').setAttribute('aria-hidden','false');
        adminEmailEl.innerText=`Admin: ${user.email}`;
        gearBtn.classList.remove('hidden');
        logoutBtn.style.display='block';
        populateAll();
        attachListeners();
      } else {
        gearBtn.classList.add('hidden');
        logoutBtn.style.display='none';
        if(auth.currentUser) signOut(auth);
        if(!user){
          roleModalBackdrop.style.display='flex';
          document.querySelector('.stage').setAttribute('aria-hidden','true');
        }
      }
    });
    
    function init(){
      createGridCells();
      createPlayers();
      populateSelects();
    }
    init();

    window.addEventListener('resize',()=>{requestAnimationFrame(()=>{get(ref(db,'game')).then(snap=>{const state=snap.exists()?snap.val():{};const p=state.playerPositions||{};const centers=computeCellCenters();for(let i=1;i<=totalPlayers;i++){updatePlayerElementLocal(i,centers,Number(p[i]||1))}})})});
  </script>
</body>
</html>
